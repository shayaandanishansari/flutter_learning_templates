import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

void main() => runApp(const MyApp());

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: BlocProvider(
        create: (_) => ItemsBloc()..add(LoadItems()),
        child: const HomePage(),
      ),
    );
  }
}

// ---- BLoC ----
class Item {
  final String id;
  final String title;
  const Item(this.id, this.title);
}

abstract class ItemsEvent {}
class LoadItems extends ItemsEvent {}
class AddItem extends ItemsEvent { final String title; AddItem(this.title); }
class DeleteItem extends ItemsEvent { final String id; DeleteItem(this.id); }
class ToggleItem extends ItemsEvent { final String id; ToggleItem(this.id); }

class ItemsState {
  final List<Item> items;
  final String? openId; // for animation (expanded item)
  ItemsState(this.items, this.openId);
}

class ItemsBloc extends Bloc<ItemsEvent, ItemsState> {
  ItemsBloc() : super(ItemsState(const [], null)) {
    on<LoadItems>((e, emit) {
      emit(ItemsState(const [Item('1', 'Sample 1'), Item('2', 'Sample 2')], null));
    });

    on<AddItem>((e, emit) {
      final t = e.title.trim().isEmpty ? 'Item ${state.items.length + 1}' : e.title.trim();
      final item = Item(DateTime.now().millisecondsSinceEpoch.toString(), t);
      emit(ItemsState([...state.items, item], state.openId));
    });

    on<DeleteItem>((e, emit) {
      emit(ItemsState(state.items.where((x) => x.id != e.id).toList(), null));
    });

    on<ToggleItem>((e, emit) {
      final next = (state.openId == e.id) ? null : e.id;
      emit(ItemsState(state.items, next));
    });
  }
}

// ---- UI ----
class HomePage extends StatelessWidget {
  const HomePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Panic Template')),
      floatingActionButton: FloatingActionButton(
        child: const Icon(Icons.add),
        onPressed: () async {
          final c = TextEditingController();
          final title = await showDialog<String>(
            context: context,
            builder: (_) => AlertDialog(
              title: const Text('Add'),
              content: TextField(controller: c, decoration: const InputDecoration(hintText: 'Title')),
              actions: [
                TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),
                ElevatedButton(onPressed: () => Navigator.pop(context, c.text), child: const Text('OK')),
              ],
            ),
          );
          if (title == null) return;
          context.read<ItemsBloc>().add(AddItem(title));
        },
      ),
      body: BlocBuilder<ItemsBloc, ItemsState>(
        builder: (_, state) {
          if (state.items.isEmpty) return const Center(child: Text('Empty'));

          return ListView(
            children: state.items.map((x) {
              final open = state.openId == x.id;

              return GestureDetector(
                onTap: () => context.read<ItemsBloc>().add(ToggleItem(x.id)),
                child: AnimatedContainer(
                  duration: const Duration(milliseconds: 200),
                  margin: const EdgeInsets.all(10),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(12),
                    color: Colors.white,
                    boxShadow: const [BoxShadow(blurRadius: 4, offset: Offset(0, 2))],
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: AnimatedSwitcher(
                          duration: const Duration(milliseconds: 200),
                          child: Text(
                            open ? '${x.title}\n\n(Animated details)' : x.title,
                            key: ValueKey(open),
                            style: const TextStyle(fontSize: 18),
                          ),
                        ),
                      ),
                      IconButton(
                        icon: const Icon(Icons.delete),
                        onPressed: () => context.read<ItemsBloc>().add(DeleteItem(x.id)),
                      ),
                    ],
                  ),
                ),
              );
            }).toList(),
          );
        },
      ),
    );
  }
}
